
name: Main worflow with Secrets scan, SAST, SCA and DAST

on:
    pull_request:
      branches:
        - main

jobs:
  ScanSecrets:
    name: Scan secrets
    runs-on: ubuntu-latest
    steps:

        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Run GitLeaks
          uses: gitleaks/gitleaks-action@v2
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - name: Set up TruffleHog
          run: |
            docker pull trufflesecurity/trufflehog:latest

        - name: Run TruffleHog
          id: trufflehog
          run: |
              docker run --rm -v $PWD:/pwd trufflesecurity/trufflehog:latest github --repo https://github.com/lucastrogo/TaskGuard --exclude-paths=/pwd/trufflehog-exclude-path.txt

  build:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # Shallow clones should be disabled for a better relevancy of analysis
          fetch-depth: 0
      - name: Scan
        uses: SonarSource/sonarcloud-github-action@v2.1.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # SonarCloud access token should be generated from https://sonarcloud.io/account/security/
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


  security:
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@master
        - name: Run Snyk to check for vulnerabilities
          uses: snyk/actions/python@master
          continue-on-error: true
          env:
            SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
